<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Securing SSH with the Vault SSH backend and GitHub authentication | Dicking with Docker</title>
<meta name="keywords" content="">
<meta name="description" content="This blog is going to be about using Hashicorp&rsquo;s Vault to issue short-lived certificates to use with SSH. Most guides have you using a username &amp; password to authenticate with Vault, but I&rsquo;ve chosen to delegate that to GitHub instead.
I&rsquo;m assuming you already have a Vault server running - I won&rsquo;t be covering that in the course of this blog. You&rsquo;ll also need a sufficiently-privileged Vault token, and jq installed on the machine you wish to SSH from.">
<meta name="author" content="Simon Weald">
<link rel="canonical" href="https://dickingwithdocker.com/posts/securing-ssh-with-the-vault-ssh-backend-and-github-authentication/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.9329d037bc79464b26647fb72e079cd738f5d2418b1df4da3b515db9e22cb4d9.css" integrity="sha256-kynQN7x5RksmZH&#43;3Lgec1zj10kGLHfTaO1FdueIstNk=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://dickingwithdocker.com/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://dickingwithdocker.com/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://dickingwithdocker.com/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://dickingwithdocker.com/apple-touch-icon.png">
<link rel="mask-icon" href="https://dickingwithdocker.com/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Securing SSH with the Vault SSH backend and GitHub authentication" />
<meta property="og:description" content="This blog is going to be about using Hashicorp&rsquo;s Vault to issue short-lived certificates to use with SSH. Most guides have you using a username &amp; password to authenticate with Vault, but I&rsquo;ve chosen to delegate that to GitHub instead.
I&rsquo;m assuming you already have a Vault server running - I won&rsquo;t be covering that in the course of this blog. You&rsquo;ll also need a sufficiently-privileged Vault token, and jq installed on the machine you wish to SSH from." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://dickingwithdocker.com/posts/securing-ssh-with-the-vault-ssh-backend-and-github-authentication/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-05-30T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-05-30T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Securing SSH with the Vault SSH backend and GitHub authentication"/>
<meta name="twitter:description" content="This blog is going to be about using Hashicorp&rsquo;s Vault to issue short-lived certificates to use with SSH. Most guides have you using a username &amp; password to authenticate with Vault, but I&rsquo;ve chosen to delegate that to GitHub instead.
I&rsquo;m assuming you already have a Vault server running - I won&rsquo;t be covering that in the course of this blog. You&rsquo;ll also need a sufficiently-privileged Vault token, and jq installed on the machine you wish to SSH from."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://dickingwithdocker.com/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Securing SSH with the Vault SSH backend and GitHub authentication",
      "item": "https://dickingwithdocker.com/posts/securing-ssh-with-the-vault-ssh-backend-and-github-authentication/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Securing SSH with the Vault SSH backend and GitHub authentication",
  "name": "Securing SSH with the Vault SSH backend and GitHub authentication",
  "description": "This blog is going to be about using Hashicorp\u0026rsquo;s Vault to issue short-lived certificates to use with SSH. Most guides have you using a username \u0026amp; password to authenticate with Vault, but I\u0026rsquo;ve chosen to delegate that to GitHub instead.\nI\u0026rsquo;m assuming you already have a Vault server running - I won\u0026rsquo;t be covering that in the course of this blog. You\u0026rsquo;ll also need a sufficiently-privileged Vault token, and jq installed on the machine you wish to SSH from.",
  "keywords": [
    
  ],
  "articleBody": "This blog is going to be about using Hashicorp’s Vault to issue short-lived certificates to use with SSH. Most guides have you using a username \u0026 password to authenticate with Vault, but I’ve chosen to delegate that to GitHub instead.\nI’m assuming you already have a Vault server running - I won’t be covering that in the course of this blog. You’ll also need a sufficiently-privileged Vault token, and jq installed on the machine you wish to SSH from.\nInitial Vault configuration Firstly, we need to make the SSH secrets engine available - the path you set will be used for all calls to the Vault API to issue certificates later on. To save time later, we’ll export this as a variable we can reference again, then enable the SSH secrets engine:\nexport VAULT_PATH=\"ssh-client\" vault secrets enable -path=${VAULT_PATH} ssh Then we need to generate a signing key and store the CA certificate (which will later be placed on all servers you want to SSH to):\nvault write ${VAULT_PATH}/config/ca generate_signing_key=true vault read -field=public_key ${VAULT_PATH}/config/ca \u003e ~/trusted-user-ca-keys.pem With that in place, we need to create a policy to define what operations can be carried out against the key signing path, so we’ll create that and then apply it:\ncat ssh-user-policy.hcl path \"${VAULT_PATH}/sign/ssh-user\" { capabilities = [\"create\",\"update\"] } vault policy write ssh-user ssh-user-policy.hcl Now we need a role which defines what actions the user is allowed to carry out against the ssh-client endpoint. We can use these options to tweak how secure we want this setup to be:\ncat ssh-user-role.hcl { \"allow_user_certificates\": true, \"allowed_users\": \"*\", \"default_user\": \"local_username\", \"allow_user_key_ids\": \"true\", \"default_extensions\": [ { \"permit-pty\": \"\", \"permit-agent-forwarding\": \"\" } ], \"key_type\": \"ca\", \"ttl\": \"5m0s\", \"allow_user_key_ids\": \"false\", \"key_id_format\": \"{{token_display_name}}\" } \"allow_user_certificates\": true\nSpecifies that this endpoint will generate user certificates (instead of host certificates).\n\"allowed_users\": \"*\"\nUsing a wildcard allows this role to sign keys for any username - you can instead provide a list of usernames and the endpoint won’t provide a certificate if the username is not in the list.\n\"default_user\": \"local_username\"\nIf no user is provided then the signed key will default to this username.\n\"default_extensions\": [ { \"permit-pty\": \"\" } ]\nSets SSH options which allow/restrict what a user can do on the remote server. permit-pty allows the user to get an interactive session, and permit-agent-forwarding allows you to forward your key with -A.\n\"ttl\": \"5m0s\"\nSetting the TTL determines how long the certificate is valid for. In this case we’re setting it to 5 minutes, so you’ll be able to use it to initiate an SSH session until the TTL expires. Once it expires, you’ll need to make a new signing request, but as we’re wrapping this in a helper function this will done automatically each time.\nNow we apply that role to our Vault path:\nvault write ${VAULT_PATH}/roles/ssh-user @ssh-user-role.hcl We can check that this action completed successfully by querying the Vault API (there is no CLI command to do this):\ncurl -s --header \"X-Vault-Token: ${VAULT_TOKEN}\" --request LIST https://${VAULT_ADDR}/v1/ssh-client/roles | jq . { \"request_id\": \"252a2e24-2e62-dc48-35e2-c49a719065f5\", \"lease_id\": \"\", \"renewable\": false, \"lease_duration\": 0, \"data\": { \"key_info\": { \"ssh-user\": { \"key_type\": \"ca\" } }, \"keys\": [ \"ssh-user\" ] }, \"wrap_info\": null, \"warnings\": null, \"auth\": null } And if you wish to check the role details:\ncurl -s --header \"X-Vault-Token: ${VAULT_TOKEN}\" https://${VAULT_ADDR}/v1/ssh-client/roles/ssh-user | jq . GitHub configuration To enable GitHub to authenticate you, you’ll need to first create an organisation (the free plan is sufficient), then you’ll need to create a team and add yourself to said team. The team name doesn’t matter, but we will need it (and the organisation name) when we configure Vault in a minute. I called my team ssh; not exactly original but it’ll get the job done.\nYou’ll also need to create a Personal Access Token with just the scope of read:org. Don’t forget to name it something logical so you remember what the token is used for in six month’s time.\nVault + GitHub Now we need to configure Vault’s GitHub authentication endpoint. First export the org and team names as variables, then still using the privileged Vault token, enable GitHub auth:\nexport ORGNAME=myorg export TEAM=myteam vault auth enable github Next, link Vault with your newly-created organisation:\nvault write auth/github/config organization=${ORGNAME} And then map the ssh-user policy to the GitHub team:\nvault write auth/github/map/teams/${TEAM} value=ssh-user Finally, in a different terminal, test out your access token to make sure you can log in:\nvault login -method=github token=${VAULT_GITHUB_TOKEN} Configuring the remote server(s) So far everything we’ve configured is for the client’s benefit - this will all have been for nothing if the destination servers don’t know to trust your Vault-signed key. To achieve that, you need to distribute the CA certificate you extracted from Vault earlier, and configure SSH to trust it.\nAssuming the CA certificate is on the destination server(s), you need to copy it to /etc/ssh and then edit your SSHD config file to reference it:\nsudo cp trusted-user-ca-keys.pem /etc/ssh/ echo \"TrustedUserCAKeys /etc/ssh/trusted-user-ca-keys.pem\" | sudo tee -a /etc/ssh/sshd_config Finally, restart the SSHD service to pick up the certificate.\nTying everything together To ensure you don’t have to provide the GitHub token each time you SSH somewhere, add it to a dotfile in your home directory (and optionally ensure only you can read it):\necho \"export VAULT_GITHUB_TOKEN=YOUR_GITHUB_TOKEN\" \u003e ~/.vault_github_token chmod 0400 ~/.vault_github_token The following functions need to be made available to your shell - they can be added to the end of your .bashrc.\nFirst up is a generic function which will obtain a signed key from Vault. You’ll need to adjust the VAULT_ADDR \u0026 VAULT_PUBLIC_SSH_KEY variables to suit your setup:\nvault_sign_key () { VAULT_ADDR=\"https://vault.mydomain.com\" VAULT_PUBLIC_SSH_KEY=~/.ssh/my_public_ssh_key.pub VAULT_SIGNED_KEY=$(echo \".ssh/vault_signed_key.pub\") VAULT_GITHUB_TOKEN_PATH=~/.vault_github_token if [[ ! -f \"${VAULT_GITHUB_TOKEN_PATH}\" ]]; then echo \"[ERR] No GitHub access token found at ${VAULT_GITHUB_TOKEN_PATH}\" return fi source \"${VAULT_GITHUB_TOKEN_PATH}\" export TMP_DIR=$(mktemp -d) VAULT_PAYLOAD=\"{\\\"token\\\":\\\"${VAULT_GITHUB_TOKEN}\\\"}\" VAULT_TOKEN=$(curl -s -X POST -d ${VAULT_PAYLOAD} ${VAULT_ADDR}/v1/auth/github/login | jq -r .auth.client_token) if ! grep -q \"s.\" \u003c\u003c\u003c $VAULT_TOKEN ; then echo \"[ERR] Vault token not retrieved.\" return fi cat \u003e \"$(echo ${TMP_DIR}/ssh-ca.json)\" \u003c\u003c EOF { \"public_key\": \"$(cat ${VAULT_PUBLIC_SSH_KEY})\", \"valid_principals\": \"${SSH_USER}\" } EOF if ! curl -s --fail -H \"X-Vault-Token: ${VAULT_TOKEN}\" -X POST -d @${TMP_DIR}/ssh-ca.json \\ ${VAULT_ADDR}/v1/ssh-client/sign/ssh-user | jq -r .data.signed_key \u003e ${VAULT_SIGNED_KEY} ; then echo \"[ERR] Failed to sign public key.\" exit 3 fi } And to initiate the SSH session we use another function. In this case, you’ll need to adjust the VAULT_PRIVATE_SSH_KEY variable to suit your setup:\nvault_ssh () { if [[ -z \"${1}\" ]]; then echo \"[INFO] Usage: vssh user@host [-p 2222]\" return fi if [[ \"${1}\" =~ ^-+ ]]; then echo \"[ERR] Additional SSH flags must be passed after the hostname. e.g. 'vssh user@host -p 2222'\" return elif [[ \"${1}\" =~ ^[a-zA-Z]+@[a-zA-Z]+ ]]; then SSH_USER=$(echo $1 | cut -d'@' -f1) SSH_HOST=$(echo $1 | cut -d'@' -f2) else SSH_USER=$(whoami) SSH_HOST=${1} fi VAULT_PRIVATE_SSH_KEY=~/.ssh/my_private_ssh_key VAULT_SIGNED_KEY=$(echo \".ssh/vault_signed_key.pub\") # sign the public key vault_sign_key # shift arguments one to the left to remove target address shift 1 # construct an SSH command with the credentials, and append any extra args ssh -i ${VAULT_SIGNED_KEY} -i ${VAULT_PRIVATE_SSH_KEY} ${SSH_USER}@${SSH_HOST} $@ } Finally, in the .bashrc we alias the command vssh to call the vault_ssh function above:\nalias vssh='vault_ssh' With this all in place, you can finally test it out:\nsource .bashrc vssh user@host Provided everything is properly configured you should connect to the destination server using your shiny new Vault-authed credentials.\nNotes The vssh function tries to work out the format of the destination address, and will accept either vssh user@host or vssh host. If the latter option is used, then your local username will be used as the remote user (as would happen if you just ran ssh host).\nYou can also provide any extra SSH flags to vssh and they will be passed through to the SSH command it constructs. The only caveat here is that the host server address must come before any additional flags. vssh user@host -p 2222 will work, whereas vssh -p 2222 user@host will generate an error message.\n",
  "wordCount" : "1324",
  "inLanguage": "en",
  "datePublished": "2020-05-30T00:00:00Z",
  "dateModified": "2020-05-30T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Simon Weald"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://dickingwithdocker.com/posts/securing-ssh-with-the-vault-ssh-backend-and-github-authentication/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Dicking with Docker",
    "logo": {
      "@type": "ImageObject",
      "url": "https://dickingwithdocker.com/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://dickingwithdocker.com/" accesskey="h" title="Dicking with Docker (Alt + H)">Dicking with Docker</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://dickingwithdocker.com/categories/" title="categories">
                    <span>categories</span>
                </a>
            </li>
            <li>
                <a href="https://dickingwithdocker.com/tags/" title="tags">
                    <span>tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://dickingwithdocker.com/">Home</a>&nbsp;»&nbsp;<a href="https://dickingwithdocker.com/posts/">Posts</a></div>
    <h1 class="post-title">
      Securing SSH with the Vault SSH backend and GitHub authentication
    </h1>
    <div class="post-meta"><span title='2020-05-30 00:00:00 +0000 UTC'>May 30, 2020</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;Simon Weald

</div>
  </header> 
  <div class="post-content"><p>This blog is going to be about using Hashicorp&rsquo;s Vault to issue short-lived certificates to use with SSH. Most guides have you using a username &amp; password to authenticate with Vault, but I&rsquo;ve chosen to delegate that to GitHub instead.</p>
<p>I&rsquo;m assuming you already have a Vault server running - I won&rsquo;t be covering that in the course of this blog. You&rsquo;ll also need a sufficiently-privileged Vault token, and <code>jq</code> installed on the machine you wish to SSH from.</p>
<h3 id="initial-vault-configuration">Initial Vault configuration<a hidden class="anchor" aria-hidden="true" href="#initial-vault-configuration">#</a></h3>
<p>Firstly, we need to make the SSH secrets engine available - the <code>path</code> you set will be used for all calls to the Vault API to issue certificates later on. To save time later, we&rsquo;ll export this as a variable we can reference again, then enable the SSH secrets engine:</p>
<pre tabindex="0"><code>export VAULT_PATH=&#34;ssh-client&#34;
vault secrets enable -path=${VAULT_PATH} ssh
</code></pre><p>Then we need to generate a signing key and store the CA certificate (which will later be placed on all servers you want to SSH to):</p>
<pre tabindex="0"><code>vault write ${VAULT_PATH}/config/ca generate_signing_key=true
vault read -field=public_key ${VAULT_PATH}/config/ca &gt; ~/trusted-user-ca-keys.pem
</code></pre><p>With that in place, we need to create a policy to define what operations can be carried out against the key signing path, so we&rsquo;ll create that and then apply it:</p>
<pre tabindex="0"><code>cat ssh-user-policy.hcl
path &#34;${VAULT_PATH}/sign/ssh-user&#34; {
    capabilities = [&#34;create&#34;,&#34;update&#34;]
}
vault policy write ssh-user ssh-user-policy.hcl
</code></pre><p>Now we need a role which defines what actions the user is allowed to carry out against the <code>ssh-client</code> endpoint. We can use these options to tweak how secure we want this setup to be:</p>
<pre tabindex="0"><code>cat ssh-user-role.hcl
{
    &#34;allow_user_certificates&#34;: true,
    &#34;allowed_users&#34;: &#34;*&#34;,
    &#34;default_user&#34;: &#34;local_username&#34;,
    &#34;allow_user_key_ids&#34;: &#34;true&#34;,
    &#34;default_extensions&#34;: [
        {
          &#34;permit-pty&#34;: &#34;&#34;,
          &#34;permit-agent-forwarding&#34;: &#34;&#34;
        }
    ],
    &#34;key_type&#34;: &#34;ca&#34;,
    &#34;ttl&#34;: &#34;5m0s&#34;,
    &#34;allow_user_key_ids&#34;: &#34;false&#34;,
    &#34;key_id_format&#34;: &#34;{{token_display_name}}&#34;
}
</code></pre><ul>
<li>
<p><code>&quot;allow_user_certificates&quot;: true</code></p>
</li>
<li>
<p>Specifies that this endpoint will generate user certificates (instead of host certificates).</p>
</li>
<li>
<p><code>&quot;allowed_users&quot;: &quot;*&quot;</code></p>
</li>
<li>
<p>Using a wildcard allows this role to sign keys for any username - you can instead provide a list of usernames and the endpoint won&rsquo;t provide a certificate if the username is not in the list.</p>
</li>
<li>
<p><code>&quot;default_user&quot;: &quot;local_username&quot;</code></p>
</li>
<li>
<p>If no user is provided then the signed key will default to this username.</p>
</li>
<li>
<p><code>&quot;default_extensions&quot;: [ { &quot;permit-pty&quot;: &quot;&quot; } ]</code></p>
</li>
<li>
<p>Sets SSH options which allow/restrict what a user can do on the remote server. <code>permit-pty</code> allows the user to get an interactive session, and <code>permit-agent-forwarding</code> allows you to forward your key with <code>-A</code>.</p>
</li>
<li>
<p><code>&quot;ttl&quot;: &quot;5m0s&quot;</code></p>
</li>
<li>
<p>Setting the TTL determines how long the certificate is valid for. In this case we&rsquo;re setting it to 5 minutes, so you&rsquo;ll be able to use it to initiate an SSH session until the TTL expires. Once it expires, you&rsquo;ll need to make a new signing request, but as we&rsquo;re wrapping this in a helper function this will done automatically each time.</p>
</li>
</ul>
<p>Now we apply that role to our Vault path:</p>
<pre tabindex="0"><code>vault write ${VAULT_PATH}/roles/ssh-user @ssh-user-role.hcl
</code></pre><p>We can check that this action completed successfully by querying the Vault API (there is no CLI command to do this):</p>
<pre tabindex="0"><code>curl -s --header &#34;X-Vault-Token: ${VAULT_TOKEN}&#34; --request LIST https://${VAULT_ADDR}/v1/ssh-client/roles | jq .
{
  &#34;request_id&#34;: &#34;252a2e24-2e62-dc48-35e2-c49a719065f5&#34;,
  &#34;lease_id&#34;: &#34;&#34;,
  &#34;renewable&#34;: false,
  &#34;lease_duration&#34;: 0,
  &#34;data&#34;: {
    &#34;key_info&#34;: {
      &#34;ssh-user&#34;: {
        &#34;key_type&#34;: &#34;ca&#34;
      }
    },
    &#34;keys&#34;: [
      &#34;ssh-user&#34;
    ]
  },
  &#34;wrap_info&#34;: null,
  &#34;warnings&#34;: null,
  &#34;auth&#34;: null
}
</code></pre><p>And if you wish to check the role details:</p>
<pre tabindex="0"><code>curl -s --header &#34;X-Vault-Token: ${VAULT_TOKEN}&#34; https://${VAULT_ADDR}/v1/ssh-client/roles/ssh-user | jq .
</code></pre><h3 id="github-configuration">GitHub configuration<a hidden class="anchor" aria-hidden="true" href="#github-configuration">#</a></h3>
<p>To enable GitHub to authenticate you, you&rsquo;ll need to first <a href="https://github.com/organizations/plan">create an organisation</a> (the free plan is sufficient), then you&rsquo;ll need to create a team and add yourself to said team. The team name doesn&rsquo;t matter, but we will need it (and the organisation name) when we configure Vault in a minute. I called my team <code>ssh</code>; not exactly original but it&rsquo;ll get the job done.</p>
<p>You&rsquo;ll also need to create a <a href="https://github.com/settings/tokens">Personal Access Token</a> with just the scope of <code>read:org</code>. Don&rsquo;t forget to name it something logical so you remember what the token is used for in six month&rsquo;s time.</p>
<h3 id="vault--github">Vault + GitHub<a hidden class="anchor" aria-hidden="true" href="#vault--github">#</a></h3>
<p>Now we need to configure Vault&rsquo;s GitHub authentication endpoint. First export the org and team names as variables, then still using the privileged Vault token, enable GitHub auth:</p>
<pre tabindex="0"><code>export ORGNAME=myorg
export TEAM=myteam
vault auth enable github
</code></pre><p>Next, link Vault with your newly-created organisation:</p>
<pre tabindex="0"><code>vault write auth/github/config organization=${ORGNAME}
</code></pre><p>And then map the ssh-user policy to the GitHub team:</p>
<pre tabindex="0"><code>vault write auth/github/map/teams/${TEAM} value=ssh-user
</code></pre><p>Finally, in a different terminal, test out your access token to make sure you can log in:</p>
<pre tabindex="0"><code>vault login -method=github token=${VAULT_GITHUB_TOKEN}
</code></pre><h3 id="configuring-the-remote-servers">Configuring the remote server(s)<a hidden class="anchor" aria-hidden="true" href="#configuring-the-remote-servers">#</a></h3>
<p>So far everything we&rsquo;ve configured is for the client&rsquo;s benefit - this will all have been for nothing if the destination servers don&rsquo;t know to trust your Vault-signed key. To achieve that, you need to distribute the CA certificate you extracted from Vault earlier, and configure SSH to trust it.</p>
<p>Assuming the CA certificate is on the destination server(s), you need to copy it to <code>/etc/ssh</code> and then edit your SSHD config file to reference it:</p>
<pre tabindex="0"><code>sudo cp trusted-user-ca-keys.pem /etc/ssh/
echo &#34;TrustedUserCAKeys /etc/ssh/trusted-user-ca-keys.pem&#34; | sudo tee -a /etc/ssh/sshd_config
</code></pre><p>Finally, restart the SSHD service to pick up the certificate.</p>
<h3 id="tying-everything-together">Tying everything together<a hidden class="anchor" aria-hidden="true" href="#tying-everything-together">#</a></h3>
<p>To ensure you don&rsquo;t have to provide the GitHub token each time you SSH somewhere, add it to a dotfile in your home directory (and optionally ensure only you can read it):</p>
<pre tabindex="0"><code>echo &#34;export VAULT_GITHUB_TOKEN=YOUR_GITHUB_TOKEN&#34; &gt; ~/.vault_github_token
chmod 0400 ~/.vault_github_token
</code></pre><p>The following functions need to be made available to your shell - they can be added to the end of your <code>.bashrc</code>.</p>
<p>First up is a generic function which will obtain a signed key from Vault. You&rsquo;ll need to adjust the <code>VAULT_ADDR</code> &amp; <code>VAULT_PUBLIC_SSH_KEY</code> variables to suit your setup:</p>
<pre tabindex="0"><code>vault_sign_key () {
  VAULT_ADDR=&#34;https://vault.mydomain.com&#34;
  VAULT_PUBLIC_SSH_KEY=~/.ssh/my_public_ssh_key.pub
  VAULT_SIGNED_KEY=$(echo &#34;.ssh/vault_signed_key.pub&#34;)
  VAULT_GITHUB_TOKEN_PATH=~/.vault_github_token

  if [[ ! -f &#34;${VAULT_GITHUB_TOKEN_PATH}&#34; ]]; then
    echo &#34;[ERR] No GitHub access token found at ${VAULT_GITHUB_TOKEN_PATH}&#34;
    return
  fi

  source &#34;${VAULT_GITHUB_TOKEN_PATH}&#34;
  export TMP_DIR=$(mktemp -d)

  VAULT_PAYLOAD=&#34;{\&#34;token\&#34;:\&#34;${VAULT_GITHUB_TOKEN}\&#34;}&#34;
  VAULT_TOKEN=$(curl -s -X POST -d ${VAULT_PAYLOAD} ${VAULT_ADDR}/v1/auth/github/login | jq -r .auth.client_token)

  if ! grep -q &#34;s.&#34; &lt;&lt;&lt; $VAULT_TOKEN ; then
    echo &#34;[ERR] Vault token not retrieved.&#34;
    return
  fi

  cat &gt; &#34;$(echo ${TMP_DIR}/ssh-ca.json)&#34; &lt;&lt; EOF
{
    &#34;public_key&#34;: &#34;$(cat ${VAULT_PUBLIC_SSH_KEY})&#34;,
    &#34;valid_principals&#34;: &#34;${SSH_USER}&#34;
}
EOF

  if ! curl -s --fail -H &#34;X-Vault-Token: ${VAULT_TOKEN}&#34; -X POST -d @${TMP_DIR}/ssh-ca.json \
      ${VAULT_ADDR}/v1/ssh-client/sign/ssh-user | jq -r .data.signed_key &gt; ${VAULT_SIGNED_KEY} ; then
    echo &#34;[ERR] Failed to sign public key.&#34;
    exit 3
  fi
}
</code></pre><p>And to initiate the SSH session we use another function. In this case, you&rsquo;ll need to adjust the <code>VAULT_PRIVATE_SSH_KEY</code> variable to suit your setup:</p>
<pre tabindex="0"><code>vault_ssh () {
  if [[ -z &#34;${1}&#34; ]]; then
    echo &#34;[INFO] Usage: vssh user@host [-p 2222]&#34;
    return
  fi

  if [[ &#34;${1}&#34; =~ ^-+ ]]; then
    echo &#34;[ERR] Additional SSH flags must be passed after the hostname. e.g. &#39;vssh user@host -p 2222&#39;&#34;
    return
  elif [[ &#34;${1}&#34; =~ ^[a-zA-Z]+@[a-zA-Z]+ ]]; then
    SSH_USER=$(echo $1 | cut -d&#39;@&#39; -f1)
    SSH_HOST=$(echo $1 | cut -d&#39;@&#39; -f2)
  else
    SSH_USER=$(whoami)
    SSH_HOST=${1}
  fi

  VAULT_PRIVATE_SSH_KEY=~/.ssh/my_private_ssh_key
  VAULT_SIGNED_KEY=$(echo &#34;.ssh/vault_signed_key.pub&#34;)

  # sign the public key
  vault_sign_key

  # shift arguments one to the left to remove target address
  shift 1

  # construct an SSH command with the credentials, and append any extra args
  ssh -i ${VAULT_SIGNED_KEY} -i ${VAULT_PRIVATE_SSH_KEY} ${SSH_USER}@${SSH_HOST} $@
}
</code></pre><p>Finally, in the <code>.bashrc</code> we alias the command <code>vssh</code> to call the <code>vault_ssh</code> function above:</p>
<pre tabindex="0"><code>alias vssh=&#39;vault_ssh&#39;
</code></pre><p>With this all in place, you can finally test it out:</p>
<pre tabindex="0"><code>source .bashrc
vssh user@host
</code></pre><p>Provided everything is properly configured you should connect to the destination server using your shiny new Vault-authed credentials.</p>
<h3 id="notes">Notes<a hidden class="anchor" aria-hidden="true" href="#notes">#</a></h3>
<p>The <code>vssh</code> function tries to work out the format of the destination address, and will accept either <code>vssh user@host</code> or <code>vssh host</code>. If the latter option is used, then your local username will be used as the remote user (as would happen if you just ran <code>ssh host</code>).</p>
<p>You can also provide any extra SSH flags to <code>vssh</code> and they will be passed through to the SSH command it constructs. The only caveat here is that the host server address must come <em>before</em> any additional flags. <code>vssh user@host -p 2222</code> will work, whereas <code>vssh -p 2222 user@host</code> will generate an error message.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://dickingwithdocker.com/posts/using-bgp-to-integrate-cilium-with-opnsense/">
    <span class="title">« Prev</span>
    <br>
    <span>Using BGP to integrate Cilium with OPNsense</span>
  </a>
  <a class="next" href="https://dickingwithdocker.com/posts/thanos-prometheus-without-kubernetes/">
    <span class="title">Next »</span>
    <br>
    <span>Thanos and Prometheus without Kubernetes</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Securing SSH with the Vault SSH backend and GitHub authentication on x"
            href="https://x.com/intent/tweet/?text=Securing%20SSH%20with%20the%20Vault%20SSH%20backend%20and%20GitHub%20authentication&amp;url=https%3a%2f%2fdickingwithdocker.com%2fposts%2fsecuring-ssh-with-the-vault-ssh-backend-and-github-authentication%2f&amp;hashtags=">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Securing SSH with the Vault SSH backend and GitHub authentication on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fdickingwithdocker.com%2fposts%2fsecuring-ssh-with-the-vault-ssh-backend-and-github-authentication%2f&amp;title=Securing%20SSH%20with%20the%20Vault%20SSH%20backend%20and%20GitHub%20authentication&amp;summary=Securing%20SSH%20with%20the%20Vault%20SSH%20backend%20and%20GitHub%20authentication&amp;source=https%3a%2f%2fdickingwithdocker.com%2fposts%2fsecuring-ssh-with-the-vault-ssh-backend-and-github-authentication%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Securing SSH with the Vault SSH backend and GitHub authentication on reddit"
            href="https://reddit.com/submit?url=https%3a%2f%2fdickingwithdocker.com%2fposts%2fsecuring-ssh-with-the-vault-ssh-backend-and-github-authentication%2f&title=Securing%20SSH%20with%20the%20Vault%20SSH%20backend%20and%20GitHub%20authentication">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Securing SSH with the Vault SSH backend and GitHub authentication on whatsapp"
            href="https://api.whatsapp.com/send?text=Securing%20SSH%20with%20the%20Vault%20SSH%20backend%20and%20GitHub%20authentication%20-%20https%3a%2f%2fdickingwithdocker.com%2fposts%2fsecuring-ssh-with-the-vault-ssh-backend-and-github-authentication%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Securing SSH with the Vault SSH backend and GitHub authentication on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=Securing%20SSH%20with%20the%20Vault%20SSH%20backend%20and%20GitHub%20authentication&u=https%3a%2f%2fdickingwithdocker.com%2fposts%2fsecuring-ssh-with-the-vault-ssh-backend-and-github-authentication%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer><div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "dickingwithdocker" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://dickingwithdocker.com/">Dicking with Docker</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
